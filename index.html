<!DOCTYPE html> 
 <html lang="pl"> 
 <head> 
 	 <meta charset="UTF-8"> 
 	 <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
 	 <title>PDF Signer</title> 
 	 <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script> 
 	 <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script> 
 	 <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"> 
 	 <style> 
 		 :root { 
 			 --primary-red: #dc2626; 
 			 --primary-red-dark: #b91c1c; 
 		 } 

 		 body { 
 			 font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
 			 background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%); 
 			 min-height: 100vh; 
 			 margin: 0; 
 			 padding: 20px 0; 
 		 } 

 		 .header-gradient { 
 			 background: linear-gradient(135deg, var(--primary-red) 0%, var(--primary-red-dark) 100%); 
 			 color: white; 
 			 padding: 20px; 
 			 border-radius: 15px 15px 0 0; 
 			 text-align: center; 
 			 box-shadow: 0 4px 15px rgba(220, 38, 38, 0.3); 
 		 } 

 		 .main-container { 
 			 width: 95%;
 			 max-width: 1200px;
 			 margin: 0 auto; 
 			 background: white; 
 			 border-radius: 15px; 
 			 box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); 
 			 overflow: hidden; 
 		 } 

 		 .step-indicator { 
 			 display: flex; 
 			 justify-content: center; 
 			 margin: 20px 0; 
 			 gap: 10px; 
 		 } 

 		 .step { 
 			 width: 40px; 
 			 height: 40px; 
 			 border-radius: 50%; 
 			 display: flex; 
 			 align-items: center; 
 			 justify-content: center; 
 			 font-weight: bold; 
 			 color: white; 
 			 background: #6b7280; 
 			 transition: all 0.3s ease; 
 		 } 

 		 .step.active { 
 			 background: var(--primary-red); 
 			 transform: scale(1.1); 
 		 } 

 		 .step.completed { 
 			 background: #10b981; 
 		 } 

 		 .card { 
 			 border: none; 
 			 border-radius: 15px; 
 			 box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); 
 			 margin: 20px; 
 			 padding: 25px; 
 		 } 

 		 .btn-primary { 
 			 background: var(--primary-red); 
 			 border: none; 
 			 border-radius: 10px; 
 			 min-height: 44px; 
 			 font-weight: 600; 
 			 transition: all 0.3s ease; 
 		 } 

 		 .btn-primary:hover { 
 			 background: var(--primary-red-dark); 
 			 transform: translateY(-2px); 
 			 box-shadow: 0 5px 15px rgba(220, 38, 38, 0.3); 
 		 } 

 		 .btn-secondary { 
 			 border-radius: 10px; 
 			 min-height: 44px; 
 			 font-weight: 600; 
 		 } 

 		 .upload-zone { 
 			 border: 3px dashed #d1d5db; 
 			 border-radius: 15px; 
 			 padding: 40px 20px; 
 			 text-align: center; 
 			 cursor: pointer; 
 			 transition: all 0.3s ease; 
 			 background: #f9fafb; 
 		 } 

 		 .upload-zone:hover, .upload-zone.dragover { 
 			 border-color: var(--primary-red); 
 			 background: #fef2f2; 
 		 } 

 		 .signature-canvas { 
 			 border: 2px solid #e5e7eb; 
 			 border-radius: 10px; 
 			 width: 100%; 
 			 height: 200px; 
 			 touch-action: none; 
 			 background: white; 
 		 } 

 		 .color-picker { 
 			 display: flex; 
 			 gap: 15px; 
 			 justify-content: center; 
 			 margin: 15px 0; 
 		 } 

 		 .color-btn { 
 			 width: 40px; 
 			 height: 40px; 
 			 border-radius: 50%; 
 			 border: 3px solid transparent; 
 			 cursor: pointer; 
 			 transition: all 0.3s ease; 
 		 } 

 		 .color-btn.active { 
 			 border-color: #374151; 
 			 transform: scale(1.1); 
 		 } 

 		 .pdf-container { 
 			 border: 2px solid #e5e7eb; 
 			 border-radius: 10px; 
 			 position: relative; 
 			 overflow: hidden; 
 			 background: white; 
 		 } 

 		 .pdf-page { 
 			 width: 100%; 
 			 cursor: crosshair; 
 		 } 

 		 .signature-preview { 
 			 position: absolute; 
 			 border: 2px dashed #3b82f6; 
 			 background: rgba(59, 130, 246, 0.1); 
 			 border-radius: 6px; 
 			 cursor: move; 
 			 display: flex; 
 			 align-items: center; 
 			 justify-content: center; 
 			 z-index: 15; 
 			 user-select: none; 
 			 pointer-events: auto; 
 		 } 

 		 .signature-overlay-mobile { 
 			 position: absolute; 
 			 border: 2px dashed #3b82f6; 
 			 background: rgba(59, 130, 246, 0.1); 
 			 border-radius: 6px; 
 			 cursor: move; 
 			 display: flex; 
 			 align-items: center; 
 			 justify-content: center; 
 			 z-index: 15; 
 			 user-select: none; 
 		 } 

 		 .resize-handle { 
 			 position: absolute; 
 			 bottom: -10px; 
 			 right: -10px; 
 			 width: 24px; 
 			 height: 24px; 
 			 background: #3b82f6; 
 			 border-radius: 50%; 
 			 cursor: se-resize; 
 			 border: 3px solid white; 
 			 box-shadow: 0 2px 8px rgba(0,0,0,0.3); 
 			 display: flex; 
 			 align-items: center; 
 			 justify-content: center; 
 			 font-size: 10px; 
 			 color: white; 
 			 font-weight: bold; 
 		 } 

 		 .signature-controls { 
 			 position: absolute; 
 			 top: -40px; 
 			 left: 0; 
 			 right: 0; 
 			 display: flex; 
 			 gap: 5px; 
 			 justify-content: center; 
 			 z-index: 20; 
 		 } 

 		 .signature-btn { 
 			 background: #10b981; 
 			 color: white; 
 			 border: none; 
 			 border-radius: 15px; 
 			 padding: 4px 8px; 
 			 font-size: 11px; 
 			 font-weight: bold; 
 			 cursor: pointer; 
 			 box-shadow: 0 2px 8px rgba(0,0,0,0.3); 
 			 transition: all 0.2s; 
 		 } 

 		 .signature-btn:hover { 
 			 background: #059669; 
 			 transform: scale(1.05); 
 		 } 

 		 .signature-btn.applied { 
 			 background: #6b7280; 
 			 cursor: default; 
 		 } 

 		 .size-controls { 
 			 display: flex; 
 			 gap: 10px; 
 			 justify-content: center; 
 			 margin: 15px 0; 
 		 } 

 		 .size-btn { 
 			 width: 40px; 
 			 height: 40px; 
 			 border-radius: 50%; 
 			 border: 2px solid #e2e8f0; 
 			 background: white; 
 			 cursor: pointer; 
 			 display: flex; 
 			 align-items: center; 
 			 justify-content: center; 
 			 transition: all 0.2s; 
 			 font-weight: bold; 
 		 } 

 		 .size-btn:hover { 
 			 border-color: #dc2626; 
 			 background: #fef2f2; 
 		 } 

 		 .page-navigation { 
 			 display: flex; 
 			 justify-content: space-between; 
 			 align-items: center; 
 			 padding: 15px; 
 			 background: #f9fafb; 
 			 border-top: 1px solid #e5e7eb; 
 		 } 

 		 .modal { 
 			 backdrop-filter: blur(5px); 
 		 } 

 		 .modal-content { 
 			 border-radius: 15px; 
 			 border: none; 
 			 box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3); 
 		 } 

 		 .progress-bar { 
 			 background: var(--primary-red); 
 			 border-radius: 10px; 
 		 } 

 		 .alert { 
 			 border-radius: 10px; 
 			 border: none; 
 		 } 

 		 .download-link { 
 			 color: var(--primary-red); 
 			 text-decoration: none; 
 			 font-weight: 600; 
 		 } 

 		 .download-link:hover { 
 			 color: var(--primary-red-dark); 
 			 text-decoration: underline; 
 		 } 

 		 .step-content { 
 			 display: none; 
 		 } 

 		 .step-content.active { 
 			 display: block; 
 		 } 

 		 /* Nowe style dla funkcjonalno≈õci wielostronicowej */ 
 		 .multi-page-controls { 
 			 background: #f0f9ff; 
 			 border: 2px solid #3b82f6; 
 			 border-radius: 10px; 
 			 padding: 15px; 
 			 margin: 15px 0; 
 			 text-align: center; 
 		 } 

 		 .btn-success { 
 			 background: #10b981; 
 			 border: none; 
 			 border-radius: 10px; 
 			 min-height: 44px; 
 			 font-weight: 600; 
 			 transition: all 0.3s ease; 
 		 } 

 		 .btn-success:hover { 
 			 background: #059669; 
 			 transform: translateY(-2px); 
 			 box-shadow: 0 5px 15px rgba(16, 185, 129, 0.3); 
 		 } 

 		 .page-status { 
 			 display: flex; 
 			 flex-wrap: wrap; 
 			 gap: 5px; 
 			 justify-content: center; 
 			 margin: 10px 0; 
 		 } 

 		 .page-indicator { 
 			 width: 30px; 
 			 height: 30px; 
 			 border-radius: 50%; 
 			 display: flex; 
 			 align-items: center; 
 			 justify-content: center; 
 			 font-size: 12px; 
 			 font-weight: bold; 
 			 border: 2px solid #e5e7eb; 
 			 background: white; 
 			 transition: all 0.3s ease; 
 		 } 

 		 .page-indicator.current { 
 			 border-color: #3b82f6; 
 			 background: #3b82f6; 
 			 color: white; 
 		 } 

 		 .page-indicator.signed { 
 			 border-color: #10b981; 
 			 background: #10b981; 
 			 color: white; 
 		 } 

 		 @media (max-width: 576px) { 
 			 .main-container {
 				 width: 100%;
 				 margin: 0;
 				 border-radius: 0;
 			 } 
 			 
 			 .card { 
 				 margin: 10px; 
 				 padding: 20px; 
 			 } 
 			 
 			 .upload-zone { 
 				 padding: 30px 15px; 
 			 } 
 		 } 
 	 </style> 
 </head> 
 <body> 
 	 <div class="main-container"> 
 		 <div class="header-gradient"> 
 			 <h1>üìù PDF Signer</h1> 
 			 <p class="mb-0">Podpisuj dokumenty PDF na dowolnym urzƒÖdzeniu</p> 
 		 </div> 

 		 <div class="step-indicator"> 
 			 <div class="step active" id="step-1">1</div> 
 			 <div class="step" id="step-2">2</div> 
 			 <div class="step" id="step-3">3</div> 
 			 <div class="step" id="step-4">4</div> 
 		 </div> 

 		 <div class="step-content active" id="content-1"> 
 			 <div class="card"> 
 				 <h3>üìÅ Krok 1: Wybierz plik PDF</h3> 
 				 <div class="upload-zone" id="uploadZone"> 
 					 <div class="mb-3"> 
 						 <i class="bi bi-cloud-upload" style="font-size: 3rem; color: var(--primary-red);"></i> 
 					 </div> 
 					 <h5>PrzeciƒÖgnij plik PDF tutaj</h5> 
 					 <p class="text-muted">lub kliknij aby wybraƒá plik</p> 
 					 <small class="text-muted">Maksymalny rozmiar: 10MB</small> 
 				 </div> 
 				 <input type="file" id="fileInput" accept=".pdf" style="display: none;"> 
 				 <div id="fileInfo" class="mt-3" style="display: none;"> 
 					 <div class="alert alert-success"> 
 						 <strong>üìÑ Plik za≈Çadowany:</strong> <span id="fileName"></span> 
 					 </div> 
 					 <button class="btn btn-primary w-100" onclick="nextStep()"> 
 						 Przejd≈∫ do podpisu ‚û°Ô∏è 
 					 </button> 
 				 </div> 
 			 </div> 
 		 </div> 

 		 <div class="step-content" id="content-2"> 
 			 <div class="card"> 
 				 <h3>‚úçÔ∏è Krok 2: Utw√≥rz podpis</h3> 
 				 <p class="text-muted">Dotknij i rysuj palcem lub myszƒÖ</p> 
 				 
 				 <div class="color-picker"> 
 					 <div class="color-btn active" data-color="#000000" style="background: #000000;"></div> 
 					 <div class="color-btn" data-color="#dc2626" style="background: #dc2626;"></div> 
 					 <div class="color-btn" data-color="#2563eb" style="background: #2563eb;"></div> 
 					 <div class="color-btn" data-color="#16a34a" style="background: #16a34a;"></div> 
 				 </div> 

 				 <canvas id="signatureCanvas" class="signature-canvas"></canvas> 
 				 
 				 <div class="d-flex gap-2 mt-3"> 
 					 <button class="btn btn-secondary flex-fill" onclick="clearSignature()"> 
 						 üóëÔ∏è Wyczy≈õƒá 
 					 </button> 
 					 <button class="btn btn-primary flex-fill" onclick="nextStep()" id="signatureNext" disabled> 
 						 Dalej ‚û°Ô∏è 
 					 </button> 
 				 </div> 
 			 </div> 
 		 </div> 

 		 <div class="step-content" id="content-3"> 
 			 <div class="card"> 
 				 <h3 style="display: flex; align-items: center; gap: 8px;"> 
 					 <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"> 
 						 <path d="M9 11H5a2 2 0 0 0-2 2v3c0 1.1.9 2 2 2h14a2 2 0 0 0 2-2v-3a2 2 0 0 0-2-2h-4"/> 
 						 <path d="M9 7l3-3 3 3"/> 
 						 <path d="M12 2v9"/> 
 					 </svg> 
 					 Umie≈õƒá podpis na dokumencie 
 				 </h3> 

 				 <div class="page-navigation"> 
 					 <button class="btn btn-secondary" onclick="previousPage()" id="prevPageBtn" disabled> 
 						 ‚Üê Poprzednia 
 					 </button> 
 					 <span id="pageInfo" style="font-weight: 600; min-width: 100px; text-align: center;">Strona 1 z 1</span> 
 					 <button class="btn btn-secondary" onclick="nextPage()" id="nextPageBtn" disabled> 
 						 Nastƒôpna ‚Üí 
 					 </button> 
 				 </div> 

 				 <div class="pdf-container" id="pdfContainer" style="border: 3px solid #3b82f6; background: #f0f9ff; position: relative; overflow: hidden; min-height: 500px; border-radius: 12px;"> 
 					 <canvas id="pdfCanvas" class="pdf-page"></canvas> 
 					 <div class="signature-preview" id="signaturePreview"></div> 
 				 </div> 

 				 <div class="size-controls" style="display: flex; align-items: center; justify-content: center; gap: 1rem; margin: 1rem 0;"> 
 					 <button class="size-btn" id="decrease-size" onclick="changeSignatureSize(-1)" style="width: 40px; height: 40px; border-radius: 50%; border: 2px solid #e2e8f0; background: white; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;">-</button> 
 					 <div class="size-display" id="size-display" style="font-size: 0.875rem; font-weight: 600; color: #1f2937; min-width: 80px; text-align: center;">Ma≈Çy</div> 
 					 <button class="size-btn" id="increase-size" onclick="changeSignatureSize(1)" style="width: 40px; height: 40px; border-radius: 50%; border: 2px solid #e2e8f0; background: white; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;">+</button> 
 				 </div> 

 				 <div class="multi-page-controls" id="multiPageControls" style="display: none;"> 
 					 <h5>üìÑ Status stron</h5> 
 					 <div class="page-status" id="pageStatus"> 
 						 </div> 
 					 
 					 <div class="d-flex gap-2 mt-3"> 
 						 <button class="btn btn-primary" onclick="applyToAllPages()" id="applyAllBtn" style="display: none;"> 
 							 üìÑ Dodaj do wszystkich stron 
 						 </button> 
 					 </div> 
 				 </div> 

 				 <div class="d-flex gap-2 mt-3"> 
 					 <button class="btn btn-secondary" onclick="previousStep()"> 
 						 <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle; margin-right: 6px;"> 
 							 <path d="M19 12H5"/> 
 							 <path d="M12 19l-7-7 7-7"/> 
 						 </svg> 
 						 Wstecz 
 					 </button> 
 					 <button class="btn btn-primary flex-fill" onclick="nextStep()" id="placementNext" disabled style="touch-action: manipulation;"> 
 						 <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle; margin-right: 6px;"> 
 							 <path d="M9 12l2 2 4-4"/> 
 							 <path d="M21 12c0 4.97-4.03 9-9 9s-9-4.03-9 9-9-4.03-9-9 4.03-9 9-9"/> 
 						 </svg> 
 						 Potwierd≈∫ 
 					 </button> 
 				 </div> 
 			 </div> 
 		 </div> 

 		 <div class="step-content" id="content-4"> 
 			 <div class="card"> 
 				 <h3>‚úÖ Krok 4: Gotowe!</h3> 
 				 <div id="processingIndicator" class="text-center"> 
 					 <div class="spinner-border text-danger" role="status"> 
 						 <span class="visually-hidden">Przetwarzanie...</span> 
 					 </div> 
 					 <p class="mt-3">Generujƒô podpisany PDF...</p> 
 				 </div> 
 				 
 				 <div id="downloadSection" style="display: none;"> 
 					 <div class="alert alert-success"> 
 						 <strong>üéâ Sukces!</strong> Tw√≥j plik zosta≈Ç podpisany. 
 					 </div> 
 					 
 					 <div class="d-grid gap-2"> 
 						 <button class="btn btn-primary" onclick="downloadPdf()"> 
 							 üì• Pobierz podpisany PDF 
 						 </button> 
 						 <button class="btn btn-secondary" onclick="sendEmail()"> 
 							 üìß Wy≈õlij email 
 						 </button> 
 						 <button class="btn btn-outline-secondary" onclick="signAnother()"> 
 							 üîÑ Podpisz kolejny 
 						 </button> 
 					 </div> 
 					 
 					 <div class="mt-3 text-center"> 
 						 <small class="text-muted"> 
 							 Mo≈ºesz te≈º kliknƒÖƒá na:  
 							 <button onclick="downloadPdf()" id="downloadFileName" class="download-link" style="background: none; border: none; text-decoration: underline;">document_podpisany.pdf</button> 
 						 </small> 
 					 </div> 
 				 </div> 
 			 </div> 
 		 </div> 
 	 </div> 

 	 <div class="modal fade" id="passwordModal" tabindex="-1" aria-hidden="true"> 
 		 <div class="modal-dialog"> 
 			 <div class="modal-content"> 
 				 <div class="modal-header"> 
 					 <h5 class="modal-title">üîí Plik chroniony has≈Çem</h5> 
 				 </div> 
 				 <div class="modal-body"> 
 					 <p>Ten plik PDF jest chroniony has≈Çem. Wprowad≈∫ has≈Ço aby kontynuowaƒá:</p> 
 					 <input type="password" class="form-control" id="passwordInput" placeholder="Wprowad≈∫ has≈Ço..."> 
 					 <div id="passwordError" class="alert alert-danger mt-2" style="display: none;"></div> 
 				 </div> 
 				 <div class="modal-footer"> 
 					 <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button> 
 					 <button type="button" class="btn btn-primary" onclick="unlockPdf()">Odblokuj</button> 
 				 </div> 
 			 </div> 
 		 </div> 
 	 </div> 

 	 <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script> 
 	 <script> 
 		 // Globalne zmienne 
 		 let currentStep = 1; 
 		 let pdfFile = null; 
 		 let pdfDoc = null; 
 		 let signatureDataUrl = null; 
 		 let signaturePosition = null; 
 		 let signatureSize = 15; 
 		 let signatureSizes = [8, 12, 15, 20, 25, 30, 35]; 
 		 let signatureSizeNames = ['Bardzo ma≈Çy', 'Ma≈Çy', '≈öredni', 'Du≈ºy', 'Bardzo du≈ºy', 'Ogromny', 'Maksymalny']; 
 		 let currentSizeIndex = 2; 
 		 let currentPage = 1; 
 		 let totalPages = 1; 
 		 let isPasswordProtected = false; 
 		 let originalPassword = null; 
 		 let unlockedPdfBytes = null; 

 		 // NOWE: Zmienne dla funkcjonalno≈õci wielostronicowej 
 		 let signaturePositions = {}; // Przechowuje pozycje podpis√≥w dla ka≈ºdej strony 
 		 let acceptedPosition = null; // Zaakceptowana pozycja podpisu 
 		 let signedPages = new Set(); // Strony z podpisami 

 		 // Canvas dla podpisu 
 		 let canvas = null; 
 		 let ctx = null; 
 		 let isDrawing = false; 
 		 let currentColor = '#000000'; 
 		 let hasSignature = false; 

 		 // PDF.js setup 
 		 pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js'; 

 		 // Inicjalizacja 
 		 document.addEventListener('DOMContentLoaded', function() { 
 			 setupFileUpload(); 
 			 setupSignatureCanvas(); 
 			 setupColorPicker(); 
 			 setupSizeControls(); 
 		 }); 

 		 function setupFileUpload() { 
 			 const uploadZone = document.getElementById('uploadZone'); 
 			 const fileInput = document.getElementById('fileInput'); 

 			 uploadZone.addEventListener('click', () => fileInput.click()); 
 			 
 			 uploadZone.addEventListener('dragover', (e) => { 
 				 e.preventDefault(); 
 				 uploadZone.classList.add('dragover'); 
 			 }); 

 			 uploadZone.addEventListener('dragleave', () => { 
 				 uploadZone.classList.remove('dragover'); 
 			 }); 

 			 uploadZone.addEventListener('drop', (e) => { 
 				 e.preventDefault(); 
 				 uploadZone.classList.remove('dragover'); 
 				 const files = e.dataTransfer.files; 
 				 if (files.length > 0) { 
 					 handleFileSelect(files[0]); 
 				 } 
 			 }); 

 			 fileInput.addEventListener('change', (e) => { 
 				 if (e.target.files.length > 0) { 
 					 handleFileSelect(e.target.files[0]); 
 				 } 
 			 }); 
 		 } 

 		 async function handleFileSelect(file) { 
 			 // Walidacja 
 			 if (file.type !== 'application/pdf') { 
 				 alert('‚ùå Mo≈ºna wybraƒá tylko pliki PDF!'); 
 				 return; 
 			 } 

 			 if (file.size > 10 * 1024 * 1024) { 
 				 alert('‚ùå Plik jest za du≈ºy! Maksymalny rozmiar to 10MB.'); 
 				 return; 
 			 } 

 			 pdfFile = file; 
 			 
 			 // Wy≈õwietl informacje o pliku 
 			 document.getElementById('fileName').textContent = file.name; 
 			 document.getElementById('fileInfo').style.display = 'block'; 

 			 // Sprawd≈∫ czy plik jest chroniony has≈Çem u≈ºywajƒÖc PDF.js 
 			 try { 
 				 const arrayBuffer = await file.arrayBuffer(); 
 				 
 				 // Pr√≥buj za≈Çadowaƒá przez PDF.js aby wykryƒá has≈Ço 
 				 try { 
 					 const loadingTask = pdfjsLib.getDocument({ data: arrayBuffer }); 
 					 const testDoc = await loadingTask.promise; 
 					 
 					 // Je≈õli siƒô uda≈Ço bez has≈Ça, plik nie jest chroniony 
 					 isPasswordProtected = false; 
 					 pdfDoc = testDoc; 
 					 totalPages = pdfDoc.numPages; 
 					 currentPage = totalPages; // Przejd≈∫ na ostatniƒÖ stronƒô 
 					 
 					 
 				 } catch (pdfError) { 
 					 if (pdfError.name === 'PasswordException') { 
 						 // Plik jest chroniony has≈Çem - poka≈º modal 
 						 isPasswordProtected = true; 
 						 showPasswordModal(); 
 						 // Nie rzucaj b≈Çƒôdu dalej - po prostu zako≈Ñcz 
 					 } else { 
 						 // Inne b≈Çƒôdy - poka≈º u≈ºytkownikowi 
 						 console.error('B≈ÇƒÖd ≈Çadowania PDF:', pdfError); 
 						 alert('‚ùå B≈ÇƒÖd podczas ≈Çadowania pliku PDF: ' + pdfError.message); 
 					 } 
 				 } 
 				 
 			 } catch (error) { 
 				 console.error('Nieoczekiwany b≈ÇƒÖd:', error); 
 				 alert('‚ùå WystƒÖpi≈Ç nieoczekiwany b≈ÇƒÖd: ' + error.message); 
 			 } 
 		 } 

 		 async function loadPdfDocument(arrayBuffer, password = null) { 
 			 try { 
 				 const loadingTask = pdfjsLib.getDocument({ 
 					 data: arrayBuffer, 
 					 password: password 
 				 }); 
 				 
 				 pdfDoc = await loadingTask.promise; 
 				 totalPages = pdfDoc.numPages; 
 				 currentPage = totalPages; // Przejd≈∫ na ostatniƒÖ stronƒô 
 				 

 			 } catch (error) { 
 				 if (error.name === 'PasswordException') { 
 					 throw new Error('B≈Çƒôdne has≈Ço'); 
 				 } 
 				 throw error; 
 			 } 
 		 } 

 		 function showPasswordModal() { 
 			 const modal = new bootstrap.Modal(document.getElementById('passwordModal')); 
 			 modal.show(); 
 		 } 

 		 async function unlockPdf() { 
 			 const password = document.getElementById('passwordInput').value; 
 			 const errorDiv = document.getElementById('passwordError'); 
 			 
 			 if (!password) { 
 				 errorDiv.textContent = 'Wprowad≈∫ has≈Ço'; 
 				 errorDiv.style.display = 'block'; 
 				 return; 
 			 } 

 			 try { 
 				 const arrayBuffer = await pdfFile.arrayBuffer(); 
 				 await loadPdfDocument(arrayBuffer, password); 
 				 
 				 // Sukces - zapisz has≈Ço i ukryj modal 
 				 originalPassword = password; 
 				 isPasswordProtected = true; 
 				 
 				 const modal = bootstrap.Modal.getInstance(document.getElementById('passwordModal')); 
 				 modal.hide(); 
 				 
 				 // Wyczy≈õƒá formularz 
 				 document.getElementById('passwordInput').value = ''; 
 				 errorDiv.style.display = 'none'; 
 				 
 			 } catch (error) { 
 				 errorDiv.textContent = error.message; 
 				 errorDiv.style.display = 'block'; 
 				 console.error('B≈ÇƒÖd odblokowania PDF:', error); 
 			 } 
 		 } 

 		 function setupSignatureCanvas() { 
 			 canvas = document.getElementById('signatureCanvas'); 
 			 if (!canvas) return; 
 			 
 			 ctx = canvas.getContext('2d'); 
 			 
 			 // Ustaw rozmiar canvas 
 			 canvas.width = canvas.offsetWidth; 
 			 canvas.height = canvas.offsetHeight; 
 			 
 			 // Ustaw styl rysowania 
 			 ctx.lineCap = 'round'; 
 			 ctx.lineJoin = 'round'; 
 			 ctx.lineWidth = 2; 
 			 ctx.strokeStyle = currentColor; 
 			 
 			 // Event listenery dla myszy 
 			 canvas.addEventListener('mousedown', startDrawing); 
 			 canvas.addEventListener('mousemove', draw); 
 			 canvas.addEventListener('mouseup', stopDrawing); 
 			 canvas.addEventListener('mouseout', stopDrawing); 
 			 
 			 // Event listenery dla dotyku 
 			 canvas.addEventListener('touchstart', handleTouch, { passive: false }); 
 			 canvas.addEventListener('touchmove', handleTouch, { passive: false }); 
 			 canvas.addEventListener('touchend', handleTouch, { passive: false }); 
 		 } 

 		 function startDrawing(e) { 
 			 isDrawing = true; 
 			 const rect = canvas.getBoundingClientRect(); 
 			 const x = e.clientX - rect.left; 
 			 const y = e.clientY - rect.top; 
 			 
 			 ctx.beginPath(); 
 			 ctx.moveTo(x, y); 
 		 } 

 		 function draw(e) { 
 			 if (!isDrawing) return; 
 			 
 			 const rect = canvas.getBoundingClientRect(); 
 			 const x = e.clientX - rect.left; 
 			 const y = e.clientY - rect.top; 
 			 
 			 ctx.lineTo(x, y); 
 			 ctx.stroke(); 
 			 
 			 // W≈ÇƒÖcz przycisk "Dalej" gdy co≈õ narysowano 
 			 if (!hasSignature) { 
 				 hasSignature = true; 
 				 document.getElementById('signatureNext').disabled = false; 
 			 } 
 		 } 

 		 function stopDrawing() { 
 			 if (isDrawing) { 
 				 isDrawing = false; 
 				 ctx.beginPath(); 
 			 } 
 		 } 

 		 function handleTouch(e) { 
 			 e.preventDefault(); 
 			 
 			 const rect = canvas.getBoundingClientRect(); 
 			 const touch = e.touches[0] || e.changedTouches[0]; 
 			 
 			 if (!touch) return; 
 			 
 			 const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' :  
 											 e.type === 'touchmove' ? 'mousemove' : 'mouseup', { 
 				 clientX: touch.clientX, 
 				 clientY: touch.clientY 
 			 }); 
 			 
 			 canvas.dispatchEvent(mouseEvent); 
 		 } 

 		 function clearSignature() { 
 			 if (ctx) { 
 				 ctx.clearRect(0, 0, canvas.width, canvas.height); 
 				 hasSignature = false; 
 				 document.getElementById('signatureNext').disabled = true; 
 			 } 
 		 } 

 		 function setupColorPicker() { 
 			 const colorBtns = document.querySelectorAll('.color-btn'); 
 			 colorBtns.forEach(btn => { 
 				 btn.addEventListener('click', () => { 
 					 // Usu≈Ñ aktywnƒÖ klasƒô z wszystkich przycisk√≥w 
 					 colorBtns.forEach(b => b.classList.remove('active')); 
 					 
 					 // Dodaj aktywnƒÖ klasƒô do klikniƒôtego przycisku 
 					 btn.classList.add('active'); 
 					 
 					 // Zmie≈Ñ kolor rysowania 
 					 currentColor = btn.getAttribute('data-color'); 
 					 if (ctx) { 
 						 ctx.strokeStyle = currentColor; 
 					 } 
 				 }); 
 			 }); 
 		 } 

 		 function setupSizeControls() { 
 			 // Inicjalizuj rozmiar 
 			 signatureSize = signatureSizes[currentSizeIndex]; 
 			 document.getElementById('size-display').textContent = signatureSizeNames[currentSizeIndex]; 
 		 } 

 		 function changeSignatureSize(direction) { 
 			 const newIndex = currentSizeIndex + direction; 
 			 
 			 if (newIndex >= 0 && newIndex < signatureSizes.length) { 
 				 currentSizeIndex = newIndex; 
 				 signatureSize = signatureSizes[currentSizeIndex]; 
 				 document.getElementById('size-display').textContent = signatureSizeNames[currentSizeIndex]; 
 				 
 				 // Zaktualizuj rozmiar podglƒÖdu podpisu je≈õli istnieje 
 				 const preview = document.getElementById('signaturePreview'); 
 				 if (preview && preview.style.display !== 'none') { 
 					 preview.style.width = `${signatureSize}%`; 
 					 preview.style.height = `${signatureSize * 0.6}%`; 
 				 } 
 			 } 
 		 } 

 		 async function renderPdfPage() { 
 			 if (!pdfDoc) { 
 				 console.error('Brak za≈Çadowanego dokumentu PDF'); 
 				 return; 
 			 } 

 			 try { 
 				 const page = await pdfDoc.getPage(currentPage); 
 				 const pdfCanvas = document.getElementById('pdfCanvas'); 
 				 const context = pdfCanvas.getContext('2d'); 
 				 
 				 const container = document.getElementById('pdfContainer'); 
 				 const containerWidth = container.offsetWidth; 
 				 
 				 const viewport = page.getViewport({ scale: 1 }); 
 				 const scale = (containerWidth / viewport.width) * 2; // Podw√≥jna rozdzielczo≈õƒá 
 				 const scaledViewport = page.getViewport({ scale: scale }); 
 				 
 				 pdfCanvas.width = scaledViewport.width; 
 				 pdfCanvas.height = scaledViewport.height; 
 				 
 				 // Ustaw rzeczywisty rozmiar wy≈õwietlany (w CSS) 
 				 pdfCanvas.style.width = (scaledViewport.width / 2) + 'px'; 
 				 pdfCanvas.style.height = (scaledViewport.height / 2) + 'px'; 
 				 
 				 const renderContext = { 
 					 canvasContext: context, 
 					 viewport: scaledViewport 
 				 }; 
 				 
 				 await page.render(renderContext).promise; 
 				 
 				 // Zaktualizuj nawigacjƒô stron 
 				 updatePageNavigation(); 
 				 
 				 // Poka≈º podglƒÖd podpisu 
 				 showSignaturePreview(); 
 				 
 				 // NOWE: Poka≈º kontrolki wielostronicowe 
 				 showMultiPageControls(); 
 				 
 				 // NOWE: Zaktualizuj status stron 
 				 updatePageStatus(); 
 				 
 				 // Za≈Çaduj pozycjƒô podpisu dla bie≈ºƒÖcej strony (je≈õli istnieje) 
 				 setTimeout(() => loadSignatureForCurrentPage(), 100); 
 				 
 			 } catch (error) { 
 				 console.error('B≈ÇƒÖd renderowania strony PDF:', error); 
 				 alert('‚ùå B≈ÇƒÖd podczas renderowania strony PDF: ' + error.message); 
 			 } 
 		 } 

 		 function updatePageNavigation() { 
 			 const prevBtn = document.getElementById('prevPageBtn'); 
 			 const nextBtn = document.getElementById('nextPageBtn'); 
 			 const pageInfo = document.getElementById('pageInfo'); 
 			 
 			 prevBtn.disabled = currentPage <= 1; 
 			 nextBtn.disabled = currentPage >= totalPages; 
 			 pageInfo.textContent = `Strona ${currentPage} z ${totalPages}`; 
 		 } 

 		 function previousPage() { 
 			 if (currentPage > 1) { 
 				 currentPage--; 
 				 renderPdfPage(); 
 				 // Sprawd≈∫ czy na tej stronie jest ju≈º zapisany podpis 
 				 loadSignatureForCurrentPage(); 
 			 } 
 		 } 

 		 function nextPage() { 
 			 if (currentPage < totalPages) { 
 				 currentPage++; 
 				 renderPdfPage(); 
 				 // Sprawd≈∫ czy na tej stronie jest ju≈º zapisany podpis 
 				 loadSignatureForCurrentPage(); 
 			 } 
 		 } 

 		 function loadSignatureForCurrentPage() { 
 			 const preview = document.getElementById('signaturePreview'); 
 			 
 			 if (signaturePositions[currentPage]) { 
 				 // Ta strona ma ju≈º zapisany podpis - poka≈º go 
 				 const savedPosition = signaturePositions[currentPage]; 
 				 
 				 preview.style.left = `${savedPosition.x}%`; 
 				 preview.style.top = `${savedPosition.y}%`; 
 				 
 				 if (savedPosition.size) { 
 					 signatureSize = savedPosition.size; 
 					 preview.style.width = `${savedPosition.size}%`; 
 					 preview.style.height = `${savedPosition.size * 0.6}%`; 
 					 
 					 // Zaktualizuj wy≈õwietlanie rozmiaru 
 					 const sizeIndex = signatureSizes.findIndex(size => size >= savedPosition.size); 
 					 if (sizeIndex >= 0) { 
 						 currentSizeIndex = sizeIndex; 
 						 document.getElementById('size-display').textContent = signatureSizeNames[sizeIndex]; 
 					 } 
 				 } 
 				 
 				 signaturePosition = { 
 					 x: savedPosition.x, 
 					 y: savedPosition.y, 
 					 page: currentPage 
 				 }; 
 			 } else { 
 				 // Brak zapisanego podpisu - ustaw domy≈õlnƒÖ pozycjƒô 
 				 preview.style.left = '25%'; 
 				 preview.style.top = '25%'; 
 				 preview.style.width = `${signatureSize}%`; 
 				 preview.style.height = `${signatureSize * 0.6}%`; 
 				 
 				 signaturePosition = { 
 					 x: 25, 
 					 y: 25, 
 					 page: currentPage 
 				 }; 
 			 } 
 			 
 			 // Zaktualizuj przyciski 
 			 updateSignatureButtons(); 
 			 updateConfirmButton(); 
 		 } 

 		 function showSignaturePreview() { 
 			 const preview = document.getElementById('signaturePreview'); 
 			 const container = document.getElementById('pdfContainer'); 
 			 
 			 if (!signatureDataUrl) return; 
 			 
 			 // Ustaw podglƒÖd podpisu z kontrolkami 
 			 preview.innerHTML = ` 
 				 <div class="signature-controls"> 
 					 <button class="signature-btn" onclick="saveSignaturePosition()" id="saveBtn-${currentPage}"> 
 						 üíæ Zapisz 
 					 </button> 
 					 <button class="signature-btn" onclick="removeSignatureFromPage()" id="removeBtn-${currentPage}" style="display: none; background: #ef4444;"> 
 						 üóëÔ∏è Usu≈Ñ 
 					 </button> 
 				 </div> 
 				 <img src="${signatureDataUrl}" style="width: 100%; height: 100%; object-fit: contain;" alt="Podpis"> 
 				 <div class="resize-handle">‚§¢</div> 
 			 `; 
 			 
 			 // Ustaw poczƒÖtkowƒÖ pozycjƒô i rozmiar 
 			 preview.style.width = `${signatureSize}%`; 
 			 preview.style.height = `${signatureSize * 0.6}%`; 
 			 preview.style.left = '25%'; 
 			 preview.style.top = '25%'; 
 			 preview.style.display = 'flex'; 
 			 
 			 // Zapisz pozycjƒô 
 			 signaturePosition = { 
 				 x: 25, 
 				 y: 25, 
 				 page: currentPage 
 			 }; 
 			 
 			 // Sprawd≈∫ czy mo≈ºna w≈ÇƒÖczyƒá przycisk "Potwierd≈∫" 
 			 updateConfirmButton(); 
 			 
 			 // Dodaj funkcjonalno≈õƒá przeciƒÖgania i zmiany rozmiaru 
 			 makeDraggable(preview); 
 			 makeResizable(preview, preview.querySelector('.resize-handle')); 
 			 
 			 // Obs≈Çuga klikniƒôcia na kontener PDF 
 			 container.addEventListener('click', handlePdfClick); 
 			 
 			 // Sprawd≈∫ czy ta strona ju≈º ma zapisany podpis 
 			 updateSignatureButtons(); 
 			 
 			 // Dodaj mobile touch handlers dla przycisk√≥w podpisu 
 			 const saveBtn = document.getElementById(`saveBtn-${currentPage}`); 
 			 const removeBtn = document.getElementById(`removeBtn-${currentPage}`); 
 			 
 			 if (saveBtn) { 
 				 saveBtn.addEventListener('touchend', function(e) { 
 					 e.preventDefault(); 
 					 e.stopPropagation(); 
 					 saveSignaturePosition(); 
 				 }, { passive: false }); 
 			 } 
 			 
 			 if (removeBtn) { 
 				 removeBtn.addEventListener('touchend', function(e) { 
 					 e.preventDefault(); 
 					 e.stopPropagation(); 
 					 removeSignatureFromPage(); 
 				 }, { passive: false }); 
 			 } 
 		 } 

 		 function handlePdfClick(e) { 
 			 if (e.target === document.getElementById('pdfCanvas')) { 
 				 const rect = e.target.getBoundingClientRect(); 
 				 const containerRect = document.getElementById('pdfContainer').getBoundingClientRect(); 
 				 
 				 const x = ((e.clientX - containerRect.left) / containerRect.width) * 100; 
 				 const y = ((e.clientY - containerRect.top) / containerRect.height) * 100; 
 				 
 				 // Upewnij siƒô, ≈ºe podpis mie≈õci siƒô w granicach 
 				 const adjustedX = Math.max(signatureSize/2, Math.min(100 - signatureSize/2, x)); 
 				 const adjustedY = Math.max(signatureSize*0.6/2, Math.min(100 - signatureSize*0.6/2, y)); 
 				 
 				 const preview = document.getElementById('signaturePreview'); 
 				 preview.style.left = `${adjustedX - signatureSize/2}%`; 
 				 preview.style.top = `${adjustedY - signatureSize*0.6/2}%`; 
 				 
 				 signaturePosition.x = adjustedX - signatureSize/2; 
 				 signaturePosition.y = adjustedY - signatureSize*0.6/2; 
 			 } 
 		 } 

 		 // NOWE FUNKCJE dla wielostronicowo≈õci 

 		 function showMultiPageControls() { 
 			 const controls = document.getElementById('multiPageControls'); 
 			 if (totalPages > 1) { 
 				 controls.style.display = 'block'; 
 			 } 
 		 } 

 		 function saveSignaturePosition() { 
 			 if (!signaturePosition) { 
 				 alert('Najpierw umie≈õƒá podpis na stronie!'); 
 				 return; 
 			 } 
 			 
 			 // Zapisz pozycjƒô dla bie≈ºƒÖcej strony 
 			 signaturePositions[currentPage] = {  
 				 x: signaturePosition.x, 
 				 y: signaturePosition.y, 
 				 page: currentPage, 
 				 size: signatureSize 
 			 }; 
 			 signedPages.add(currentPage); 
 			 
 			 // Ustaw jako zaakceptowanƒÖ pozycjƒô (do u≈ºycia na innych stronach) 
 			 acceptedPosition = { 
 				 x: signaturePosition.x, 
 				 y: signaturePosition.y, 
 				 size: signatureSize 
 			 }; 
 			 
 			 // Zaktualizuj UI 
 			 updatePageStatus(); 
 			 updateSignatureButtons(); 
 			 updateConfirmButton(); 
 			 
 			 // Poka≈º przycisk "Dodaj do wszystkich" g≈Ç√≥wny 
 			 if (totalPages > 1) { 
 				 const mainApplyBtn = document.getElementById('applyAllBtn'); 
 				 mainApplyBtn.style.display = 'inline-block'; 
 				 
 				 // Dodaj mobile touch handler je≈õli jeszcze nie zosta≈Ç dodany 
 				 if (!mainApplyBtn.hasAttribute('data-mobile-ready')) { 
 					 mainApplyBtn.addEventListener('touchend', function(e) { 
 						 e.preventDefault(); 
 						 e.stopPropagation(); 
 						 applyToAllPages(); 
 					 }, { passive: false }); 
 					 
 					 mainApplyBtn.setAttribute('data-mobile-ready', 'true'); 
 				 } 
 			 } 
 			 
 			 alert('‚úÖ Pozycja podpisu zosta≈Ça zapisana dla tej strony!'); 
 		 } 

 		 function updateSignatureButtons() { 
 			 const saveBtn = document.getElementById(`saveBtn-${currentPage}`); 
 			 const removeBtn = document.getElementById(`removeBtn-${currentPage}`); 
 			 
 			 if (signedPages.has(currentPage)) { 
 				 if (saveBtn) { 
 					 saveBtn.textContent = '‚úÖ Zapisano'; 
 					 saveBtn.classList.add('applied'); 
 					 saveBtn.onclick = null; 
 				 } 
 				 // Poka≈º przycisk "Usu≈Ñ" je≈õli strona ma podpis 
 				 if (removeBtn) { 
 					 removeBtn.style.display = 'inline-block'; 
 				 } 
 			 } else { 
 				 // Ukryj przycisk "Usu≈Ñ" je≈õli strona nie ma podpisu 
 				 if (removeBtn) { 
 					 removeBtn.style.display = 'none'; 
 				 } 
 			 } 
 		 } 

 		 function removeSignatureFromPage() { 
 			 if (!signedPages.has(currentPage)) { 
 				 alert('Ta strona nie ma zapisanego podpisu!'); 
 				 return; 
 			 } 
 			 
 			 // Usu≈Ñ podpis z danej strony 
 			 delete signaturePositions[currentPage]; 
 			 signedPages.delete(currentPage); 
 			 
 			 // Zaktualizuj UI 
 			 updatePageStatus(); 
 			 updateSignatureButtons(); 
 			 updateConfirmButton(); 
 			 
 			 alert('üóëÔ∏è Podpis zosta≈Ç usuniƒôty z tej strony!'); 
 		 } 

 		 function updatePageStatus() { 
 			 const statusContainer = document.getElementById('pageStatus'); 
 			 statusContainer.innerHTML = ''; 
 			 
 			 for (let i = 1; i <= totalPages; i++) { 
 				 const indicator = document.createElement('div'); 
 				 indicator.className = 'page-indicator'; 
 				 indicator.textContent = i; 
 				 
 				 if (i === currentPage) { 
 					 indicator.classList.add('current'); 
 				 } 
 				 if (signedPages.has(i)) { 
 					 indicator.classList.add('signed'); 
 				 } 
 				 
 				 statusContainer.appendChild(indicator); 
 			 } 
 		 } 


 		 function applyToAllPages() { 
 			 if (!acceptedPosition) { 
 				 alert('Najpierw zapisz pozycjƒô podpisu na jakiej≈õ stronie!'); 
 				 return; 
 			 } 
 			 
 			 // Dodaj podpis do wszystkich stron (poza ju≈º podpisanymi) 
 			 for (let i = 1; i <= totalPages; i++) { 
 				 if (!signedPages.has(i)) { 
 					 signaturePositions[i] = { 
 						 x: acceptedPosition.x, 
 						 y: acceptedPosition.y, 
 						 page: i, 
 						 size: acceptedPosition.size 
 					 }; 
 					 signedPages.add(i); 
 				 } 
 			 } 
 			 
 			 // Zaktualizuj UI 
 			 updatePageStatus(); 
 			 updateSignatureButtons(); 
 			 updateConfirmButton(); 
 			 alert(`‚úÖ Podpis zosta≈Ç dodany do wszystkich ${totalPages} stron!`); 
 		 } 

 		 function makeDraggable(element) { 
 			 let isDragging = false; 
 			 let startX, startY, startLeft, startTop; 
 			 
 			 const handleStart = (e) => { 
 				 // Don't drag if touching resize handle 
 				 if (e.target.classList.contains('resize-handle')) return; 
 				 
 				 isDragging = true; 
 				 const clientX = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX; 
 				 const clientY = e.type === 'touchstart' ? e.touches[0].clientY : e.clientY; 
 				 
 				 startX = clientX; 
 				 startY = clientY; 
 				 startLeft = parseFloat(element.style.left); 
 				 startTop = parseFloat(element.style.top); 
 				 
 				 // Visual feedback 
 				 element.style.opacity = '0.8'; 
 				 element.style.transform = 'scale(1.05)'; 
 				 element.style.zIndex = '20'; 
 				 
 				 e.preventDefault(); 
 				 e.stopPropagation(); 
 			 }; 
 			 
 			 const handleMove = (e) => { 
 				 if (!isDragging) return; 
 				 
 				 const clientX = e.type === 'touchmove' ? e.touches[0].clientX : e.clientX; 
 				 const clientY = e.type === 'touchmove' ? e.touches[0].clientY : e.clientY; 
 				 
 				 const rect = document.getElementById('pdfContainer').getBoundingClientRect(); 
 				 const deltaX = ((clientX - startX) / rect.width) * 100; 
 				 const deltaY = ((clientY - startY) / rect.height) * 100; 
 				 
 				 const newLeft = Math.max(0, Math.min(85, startLeft + deltaX)); 
 				 const newTop = Math.max(0, Math.min(85, startTop + deltaY)); 
 				 
 				 element.style.left = `${newLeft}%`; 
 				 element.style.top = `${newTop}%`; 
 				 
 				 signaturePosition.x = newLeft; 
 				 signaturePosition.y = newTop; 
 				 
 				 e.preventDefault(); 
 			 }; 
 			 
 			 const handleEnd = () => { 
 				 if (isDragging) { 
 					 isDragging = false; 
 					 
 					 // Reset visual feedback 
 					 element.style.opacity = '1'; 
 					 element.style.transform = 'scale(1)'; 
 					 element.style.zIndex = '15'; 
 					 
 					 // Zaktualizuj pozycjƒô podpisu 
 					 signaturePosition.x = parseFloat(element.style.left); 
 					 signaturePosition.y = parseFloat(element.style.top); 
 					 signaturePosition.page = currentPage; 
 				 } 
 			 }; 
 			 
 			 element.addEventListener('mousedown', handleStart); 
 			 element.addEventListener('touchstart', handleStart, { passive: false }); 
 			 document.addEventListener('mousemove', handleMove); 
 			 document.addEventListener('touchmove', handleMove, { passive: false }); 
 			 document.addEventListener('mouseup', handleEnd); 
 			 document.addEventListener('touchend', handleEnd); 
 		 } 

 		 function makeResizable(element, handle) { 
 			 let isResizing = false; 
 			 let startSize, startClientX; 
 			 
 			 const handleStart = (e) => { 
 				 isResizing = true; 
 				 startSize = signatureSize; 
 				 startClientX = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX; 
 				 
 				 // Visual feedback 
 				 handle.style.background = '#ef4444'; 
 				 handle.style.transform = 'scale(1.2)'; 
 				 
 				 e.preventDefault(); 
 				 e.stopPropagation(); 
 			 }; 
 			 
 			 const handleMove = (e) => { 
 				 if (!isResizing) return; 
 				 
 				 const clientX = e.type === 'touchmove' ? e.touches[0].clientX : e.clientX; 
 				 const deltaX = clientX - startClientX; 
 				 const rect = document.getElementById('pdfContainer').getBoundingClientRect(); 
 				 
 				 // Calculate new size based on movement 
 				 const sizeDelta = (deltaX / rect.width) * 50; // Sensitivity 
 				 const newSize = Math.max(8, Math.min(35, startSize + sizeDelta)); 
 				 
 				 signatureSize = newSize; 
 				 
 				 // Update element size 
 				 element.style.width = `${newSize}%`; 
 				 element.style.height = `${newSize * 0.6}%`; 
 				 
 				 // Update size display 
 				 const sizeIndex = signatureSizes.findIndex(size => size >= newSize); 
 				 if (sizeIndex >= 0) { 
 					 currentSizeIndex = sizeIndex; 
 					 document.getElementById('size-display').textContent = signatureSizeNames[sizeIndex]; 
 				 } 
 				 
 				 e.preventDefault(); 
 			 }; 
 			 
 			 const handleEnd = () => { 
 				 if (isResizing) { 
 					 isResizing = false; 
 					 
 					 // Reset visual feedback 
 					 handle.style.background = '#3b82f6'; 
 					 handle.style.transform = 'scale(1)'; 
 					 
 					 // Zaktualizuj rozmiar w pozycji podpisu 
 					 if (signaturePosition) { 
 						 signaturePosition.size = signatureSize; 
 					 } 
 				 } 
 			 }; 
 			 
 			 handle.addEventListener('mousedown', handleStart); 
 			 handle.addEventListener('touchstart', handleStart, { passive: false }); 
 			 document.addEventListener('mousemove', handleMove); 
 			 document.addEventListener('touchmove', handleMove, { passive: false }); 
 			 document.addEventListener('mouseup', handleEnd); 
 			 document.addEventListener('touchend', handleEnd); 
 		 } 

 		 function nextStep() { 
 			 if (currentStep < 4) { 
 				 // Ukryj aktualny krok 
 				 document.getElementById(`content-${currentStep}`).classList.remove('active'); 
 				 document.getElementById(`step-${currentStep}`).classList.remove('active'); 
 				 document.getElementById(`step-${currentStep}`).classList.add('completed'); 

 				 currentStep++; 

 				 // Poka≈º nastƒôpny krok 
 				 document.getElementById(`content-${currentStep}`).classList.add('active'); 
 				 document.getElementById(`step-${currentStep}`).classList.add('active'); 

 				 // Specjalne akcje dla konkretnych krok√≥w 
 				 if (currentStep === 2) { 
 					 // Krok 2: Przygotuj canvas 
 					 setupSignatureCanvas(); 
 				 } else if (currentStep === 3) { 
 					 // Krok 3: Renderuj PDF 
 					 signatureDataUrl = canvas.toDataURL(); 
 					 renderPdfPage(); 
 				 } else if (currentStep === 4) { 
 					 // Sprawd≈∫ czy mamy jakie≈õ podpisy do dodania 
 					 if (signedPages.size === 0 && !signaturePosition) { 
 						 alert('‚ùå Najpierw zapisz podpis na przynajmniej jednej stronie!'); 
 						 currentStep--; // Powr√≥ƒá do poprzedniego kroku 
 						 document.getElementById(`content-${currentStep + 1}`).classList.remove('active'); 
 						 document.getElementById(`step-${currentStep + 1}`).classList.remove('active'); 
 						 document.getElementById(`content-${currentStep}`).classList.add('active'); 
 						 document.getElementById(`step-${currentStep}`).classList.add('active'); 
 						 return; 
 					 } 
 					 
 					 // Krok 4: Od razu poka≈º sukces, generuj PDF w tle 
 					 document.getElementById('processingIndicator').style.display = 'none'; 
 					 document.getElementById('downloadSection').style.display = 'block'; 
 					 
 					 // Ustaw tymczasowƒÖ nazwƒô pliku 
 					 const fileName = pdfFile ? pdfFile.name.replace('.pdf', '_podpisany.pdf') : 'podpisany.pdf'; 
 					 showDownloadButtons(fileName); 
 					 
 					 // Generuj PDF w tle 
 					 generateSignedPdf(); 
 				 } 
 			 } 
 		 } 

 		 function previousStep() { 
 			 if (currentStep > 1) { 
 				 // Ukryj aktualny krok 
 				 document.getElementById(`content-${currentStep}`).classList.remove('active'); 
 				 document.getElementById(`step-${currentStep}`).classList.remove('active'); 

 				 currentStep--; 

 				 // Poka≈º poprzedni krok 
 				 document.getElementById(`content-${currentStep}`).classList.add('active'); 
 				 document.getElementById(`step-${currentStep}`).classList.add('active'); 
 				 document.getElementById(`step-${currentStep}`).classList.remove('completed'); 
 			 } 
 		 } 

 		 // Funkcja pomocnicza do konwersji DataURL na ArrayBuffer 
 		 function dataURLToArrayBuffer(dataUrl) { 
 			 const base64 = dataUrl.split(',')[1]; 
 			 const binaryString = atob(base64); 
 			 const bytes = new Uint8Array(binaryString.length); 
 			 for (let i = 0; i < binaryString.length; i++) { 
 				 bytes[i] = binaryString.charCodeAt(i); 
 			 } 
 			 return bytes; 
 		 } 

 		 async function generateSignedPdf() { 
 			 try { 
 				 
 				 // Nie pokazuj wska≈∫nika ≈Çadowania - od razu przejd≈∫ do wynik√≥w 

 				 // Nowe podej≈õcie - renderuj strony jako obrazy i utw√≥rz nowy PDF 
 				 
 				 // Utw√≥rz ca≈Çkowicie nowy dokument 
 				 const finalPdfDoc = await PDFLib.PDFDocument.create(); 
 				 
 				 // Renderuj ka≈ºdƒÖ stronƒô jako obraz u≈ºywajƒÖc PDF.js 
 				 for (let pageNum = 1; pageNum <= totalPages; pageNum++) { 
 					 
 					 const page = await pdfDoc.getPage(pageNum); 
 					 const viewport = page.getViewport({ scale: 2.0 }); // Wysoka rozdzielczo≈õƒá 
 					 
 					 // Utw√≥rz canvas do renderowania 
 					 const canvas = document.createElement('canvas'); 
 					 const context = canvas.getContext('2d'); 
 					 canvas.height = viewport.height; 
 					 canvas.width = viewport.width; 
 					 
 					 // Renderuj stronƒô PDF.js do canvas 
 					 const renderContext = { 
 						 canvasContext: context, 
 						 viewport: viewport 
 					 }; 
 					 
 					 await page.render(renderContext).promise; 
 					 
 					 // Konwertuj canvas na dane obrazu 
 					 const imageDataUrl = canvas.toDataURL('image/png'); 
 					 const imageBytes = dataURLToArrayBuffer(imageDataUrl); 
 					 
 					 // Osad≈∫ obraz w nowym dokumencie PDF 
 					 const pngImage = await finalPdfDoc.embedPng(imageBytes); 
 					 const pdfPage = finalPdfDoc.addPage([viewport.width / 2, viewport.height / 2]); // Skaluj w d√≥≈Ç 
 					 
 					 pdfPage.drawImage(pngImage, { 
 						 x: 0, 
 						 y: 0, 
 						 width: viewport.width / 2, 
 						 height: viewport.height / 2, 
 					 }); 
 					 
 				 } 
 				 
 				 
 				 // Sprawd≈∫ rozmiary stron 
 				 for (let i = 0; i < finalPdfDoc.getPageCount(); i++) { 
 					 const page = finalPdfDoc.getPage(i); 
 					 const size = page.getSize(); 
 				 } 

 				 // Sprawd≈∫ czy mamy dane podpisu 
 				 if (!signatureDataUrl) { 
 					 throw new Error('Brak danych podpisu. Narysuj podpis ponownie.'); 
 				 } 

 				 // NOWE: Dodaj podpisy do wszystkich oznaczonych stron 
 				 const signatureImage = await finalPdfDoc.embedPng(signatureDataUrl); 
 				 
 				 for (const pageNum of signedPages) { 
 					 const position = signaturePositions[pageNum]; 
 					 if (!position) continue; 
 					 
 					 const targetPage = finalPdfDoc.getPage(pageNum - 1); 
 					 const { width: pageWidth, height: pageHeight } = targetPage.getSize(); 

 					 // Przelicz pozycjƒô (PDF u≈ºywa uk≈Çadu wsp√≥≈Çrzƒôdnych od do≈Çu) 
 					 const signatureWidth = (acceptedPosition ? acceptedPosition.size : signatureSize) / 100 * pageWidth; 
 					 const signatureHeight = (acceptedPosition ? acceptedPosition.size : signatureSize) / 100 * pageHeight * 0.6; // Proporcje 60% 
 					 
 					 const x = (position.x / 100) * pageWidth; 
 					 const y = pageHeight - (position.y / 100) * pageHeight - signatureHeight; 

 					 targetPage.drawImage(signatureImage, { 
 						 x: x, 
 						 y: y, 
 						 width: signatureWidth, 
 						 height: signatureHeight, 
 					 }); 
 				 } 
 				 
 				 // Zapisz i pobierz (dok≈Çadnie jak w wersji 3) 
 				 const pdfBytes = await finalPdfDoc.save(); 
 				 
 				 const originalName = pdfFile.name.replace(/\.pdf$/i, ''); 
 				 const signedName = `${originalName}_podpisany.pdf`; 
 				 
 				 // Tworz Blob i pobierz (metoda z wersji 3) 
 				 const signedBlob = new Blob([pdfBytes], { type: 'application/pdf' }); 
 				 
 				 
 				 // Zapisz plik do zmiennych globalnych 
 				 window.signedPdfBlob = signedBlob; 
 				 window.signedPdfName = signedName; 
 				 
 				 
 				 
 				 // Poka≈º sekcjƒô z przyciskami 
 				 showDownloadButtons(signedName); 
 				 
 				 // Wska≈∫nik ≈Çadowania pominiƒôty 

 			 } catch (error) { 
 				 console.error('B≈ÇƒÖd generowania PDF:', error); 
 			 } 
 		 } 

 		 // Funkcja usuniƒôta - zastƒÖpiona przez sendEmail() 

 		 function showDownloadButtons(fileName) { 
 			 // Poka≈º sekcjƒô download 
 			 document.getElementById('downloadSection').style.display = 'block'; 
 			 
 			 // Ustaw tymczasowƒÖ nazwƒô pliku dla funkcji, kt√≥re jej potrzebujƒÖ 
 			 if (!window.signedPdfName) { 
 				 window.signedPdfName = fileName; 
 			 } 
 			 
 			 // Zaktualizuj nazwƒô pliku 
 			 const fileNameElement = document.getElementById('downloadFileName'); 
 			 if (fileNameElement) { 
 				 fileNameElement.textContent = fileName; 
 			 } 
 			 
 			 // Zaktualizuj krok 
 			 // updateStep(4); // Funkcja dodana poni≈ºej 
 		 } 
 		 
 		 function downloadPdf() { 
 			 // Prosta implementacja - je≈õli PDF nie gotowy, wygeneruj go teraz 
 			 if (!window.signedPdfBlob || !window.signedPdfName) { 
 					 generatePdfSync(); 
 				 return; 
 			 } 
 			 
 			 // PDF gotowy - pobierz 
 			 try { 
 				 const url = URL.createObjectURL(window.signedPdfBlob); 
 				 const link = document.createElement('a'); 
 				 link.href = url; 
 				 link.download = window.signedPdfName; 
 				 link.style.display = 'none'; 
 				 document.body.appendChild(link); 
 				 link.click(); 
 				 document.body.removeChild(link); 
 				 
 				 setTimeout(() => URL.revokeObjectURL(url), 1000); 
 			 } catch (error) { 
 				 console.error('B≈ÇƒÖd pobierania:', error); 
 			 } 
 		 } 
 		 
 		 // Nowa prosta funkcja generowania PDF synchronicznie 
 		 async function generatePdfSync() { 
 			 try { 
 				 
 				 if (!signatureDataUrl) { 
 					 return; 
 				 } 
 				 
 				 // Za≈Çaduj oryginalny PDF u≈ºywajƒÖc PDF-lib 
 				 const arrayBuffer = await pdfFile.arrayBuffer(); 
 				 const finalPdfDoc = await PDFLib.PDFDocument.load(arrayBuffer); 
 				 const pages = finalPdfDoc.getPages(); 
 				 
 				 // NOWE: Dodaj podpisy do wszystkich oznaczonych stron 
 				 const signatureBytes = dataURLToArrayBuffer(signatureDataUrl); 
 				 const signatureImage = await finalPdfDoc.embedPng(signatureBytes); 
 				 
 				 for (const pageNum of signedPages) { 
 					 const position = signaturePositions[pageNum]; 
 					 if (!position) continue; 
 					 
 					 const targetPage = pages[pageNum - 1]; 
 					 const { width, height } = targetPage.getSize(); 
 					 
 					 const signatureWidth = (acceptedPosition ? acceptedPosition.size : signatureSize) / 100 * width; 
 					 const signatureHeight = (acceptedPosition ? acceptedPosition.size : signatureSize) / 100 * height * 0.6; 
 					 
 					 const x = (position.x / 100) * width; 
 					 const y = height - (position.y / 100) * height - signatureHeight; 
 					 
 					 targetPage.drawImage(signatureImage, { 
 						 x: x, 
 						 y: y, 
 						 width: signatureWidth, 
 						 height: signatureHeight, 
 					 }); 
 				 } 
 				 
 				 // Zapisz PDF 
 				 const pdfBytes = await finalPdfDoc.save(); 
 				 const signedName = pdfFile.name.replace('.pdf', '_podpisany.pdf'); 
 				 const signedBlob = new Blob([pdfBytes], { type: 'application/pdf' }); 
 				 
 				 // Zapisz do zmiennych globalnych 
 				 window.signedPdfBlob = signedBlob; 
 				 window.signedPdfName = signedName; 
 				 
 				 
 				 // Teraz pobierz 
 				 downloadPdf(); 
 				 
 			 } catch (error) { 
 				 console.error('B≈ÇƒÖd synchronicznego generowania PDF:', error); 
 			 } 
 		 } 
 		 
 		 function sendEmail() { 
 			 // U≈ºyj nazwy pliku z uploadedFile je≈õli signedPdfName jeszcze nie gotowe 
 			 const fileName = window.signedPdfName || (window.uploadedFile ? window.uploadedFile.name.replace('.pdf', '_podpisany.pdf') : 'podpisany.pdf'); 
 			 
 			 const subject = encodeURIComponent('Podpisany dokument PDF'); 
 			 const body = encodeURIComponent(`Za≈ÇƒÖczam podpisany dokument: ${fileName}\n\nDokument zosta≈Ç podpisany za pomocƒÖ aplikacji PDF Signer.`); 
 			 window.location.href = `mailto:?subject=${subject}&body=${body}`; 
 			 
 			 // Spr√≥buj te≈º udostƒôpniƒá przez API udostƒôpniania je≈õli dostƒôpne 
 			 if (navigator.share && window.signedPdfBlob) { 
 				 navigator.share({ 
 					 title: 'Podpisany dokument PDF', 
 					 text: 'Przesy≈Çam podpisany dokument PDF', 
 					 files: [new File([window.signedPdfBlob], fileName, { type: 'application/pdf' })] 
 				 }).catch(console.error); 
 			 } 
 		 } 
 		 
 		 function updateStep(stepNumber) { 
 			 // Aktualizuj wska≈∫nik krok√≥w 
 			 document.querySelectorAll('.step').forEach(step => { 
 				 step.classList.remove('active'); 
 			 }); 
 			 document.getElementById(`step-${stepNumber}`).classList.add('active'); 
 		 } 

 		 function signAnother() { 
 			 // Reset wszystkich zmiennych 
 			 window.signedPdfBlob = null; 
 			 window.signedPdfName = null; 
 			 
 			 // Prze≈Çaduj stronƒô ≈ºeby zresetowaƒá ca≈Çy stan 
 			 window.location.reload(); 
 		 } 

 		 function restartProcess() { 
 			 // Reset wszystkich zmiennych 
 			 currentStep = 1; 
 			 pdfFile = null; 
 			 pdfDoc = null; 
 			 signatureDataUrl = null; 
 			 signaturePosition = null; 
 			 signatureSize = 100; 
 			 currentPage = 1; 
 			 totalPages = 1; 
 			 isPasswordProtected = false; 
 			 originalPassword = null; 
 			 unlockedPdfBytes = null; 
 			 hasSignature = false; 

 			 // NOWE: Reset zmiennych wielostronicowych 
 			 signaturePositions = {}; 
 			 acceptedPosition = null; 
 			 signedPages = new Set(); 

 			 // Reset UI 
 			 document.querySelectorAll('.step-content').forEach(content => { 
 				 content.classList.remove('active'); 
 			 }); 
 			 document.querySelectorAll('.step').forEach(step => { 
 				 step.classList.remove('active', 'completed'); 
 			 }); 

 			 document.getElementById('content-1').classList.add('active'); 
 			 document.getElementById('step-1').classList.add('active'); 
 			 document.getElementById('fileInfo').style.display = 'none'; 
 			 document.getElementById('signatureNext').disabled = true; 
 			 document.getElementById('placementNext').disabled = true; 

 			 // Wyczy≈õƒá canvas 
 			 if (canvas && ctx) { 
 				 ctx.clearRect(0, 0, canvas.width, canvas.height); 
 			 } 

 			 // Reset formularza 
 			 document.getElementById('fileInput').value = ''; 
 			 document.getElementById('passwordInput').value = ''; 
 			 document.getElementById('passwordError').style.display = 'none'; 

 			 // Reset kolor√≥w i rozmiar√≥w 
 			 document.querySelectorAll('.color-btn').forEach(btn => btn.classList.remove('active')); 
 			 document.querySelector('.color-btn[data-color="#000000"]').classList.add('active'); 
 			 currentColor = '#000000'; 

 			 document.querySelectorAll('.size-btn').forEach(btn => btn.classList.remove('active')); 
 			 document.querySelector('.size-btn[data-size="100"]').classList.add('active'); 
 		 } 

 		 function updateConfirmButton() { 
 			 const confirmBtn = document.getElementById('placementNext'); 
 			 if (confirmBtn) { 
 				 confirmBtn.disabled = signedPages.size === 0; 
 				 
 				 // Dodaj mobile touch handler je≈õli jeszcze nie zosta≈Ç dodany 
 				 if (!confirmBtn.hasAttribute('data-mobile-ready')) { 
 					 confirmBtn.addEventListener('touchstart', function(e) { 
 						 if (!confirmBtn.disabled) { 
 							 e.preventDefault(); 
 							 e.stopPropagation(); 
 						 } 
 					 }, { passive: false }); 
 					 
 					 confirmBtn.addEventListener('touchend', function(e) { 
 						 if (!confirmBtn.disabled) { 
 							 e.preventDefault(); 
 							 e.stopPropagation(); 
 							 nextStep(); 
 						 } 
 					 }, { passive: false }); 
 					 
 					 confirmBtn.setAttribute('data-mobile-ready', 'true'); 
 				 } 
 			 } 
 		 } 

 		 // Obs≈Çuga klawisza Enter w modal has≈Ça 
 		 document.getElementById('passwordInput').addEventListener('keypress', function(e) { 
 			 if (e.key === 'Enter') { 
 				 unlockPdf(); 
 			 } 
 		 }); 
 	 </script> 
 </body> 
 </html>
